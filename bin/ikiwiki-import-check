#!/usr/pkg/bin/perl

use warnings;
use strict;
use utf8;

package IkiWiki::Import::Check;

use Test::More;

use Text::Diff;

use IkiWiki;

sub remove_unimportant_differences {
	my ($html) = @_;

	# anything before or after the article body
	$html =~ s|^.+<p>I first learned of|<p>I first learned of|s;
	$html =~ s|it finally becomes simple.</p>.+$|it finally becomes simple.</p>|s;

	# paragraph-leading whitespace
	$html =~ s|^(\s)*<p>|<p>|msg;

	# accented characters
	$html =~ s|Ã©|&eacute;|msg;

	# smart apostrophes
	$html =~ s|&#8217;|'|msg;
	$html =~ s|&#39;|'|msg;

	# smart em-dashes
	$html =~ s|&#8212;|--|msg;

	return $html;
}

sub get_txp_post_body {
	my ($relative_permalink) = @_;
	return remove_unimportant_differences(
		readfile("www.schmonz.com/$relative_permalink/index.html"),
	);
}

sub get_iki_post_body {
	my ($relative_permalink) = @_;
	return remove_unimportant_differences(
		readfile("outly/$relative_permalink/index.html"),
	);
}

sub diff_ok {
	my ($old, $new, $description) = @_;
	my $diff = diff \$old, \$new;
	is($diff, q{}, $description);
}

my $relative_permalink = '2014/01/28/on-some-cusps';
diff_ok(
	get_txp_post_body($relative_permalink),
	get_iki_post_body($relative_permalink),
	q{old and new post are sufficiently similar},
);

done_testing();
